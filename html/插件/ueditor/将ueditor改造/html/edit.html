{include file="common/header" /}
<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
    <div class="widget">
        <div class="widget-header bordered-bottom bordered-lightred">
            <span class="widget-caption">Horizontal Form</span>
        </div>
        <div class="widget-body">
            <div id="horizontal-form">
                <form id="togglingForm" class="form-horizontal" role="form" enctype="multipart/form-data"  method="post">
                    <div class="form-group">
                        <label for="cate_id" class="col-xs-2 col-sm-2 col-md-2 col-lg-2 control-label no-padding-right">栏目</label>
                        <div class="col-xs-10 col-sm-10 col-md-10 col-lg-10">
                            <select id="cate_id" style="width:100%;" name="cate_id">
                                <option value="0" />空分类
                                {foreach name="cate_datas" item="v" key="k" }
                                <option  value="{$v['cate_id']}" {if condition="($v['cate_id'] == $article_data['cate_id'])"}selected{/if}/>{$v['cate_name']}
                                {/foreach}
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="title" class="col-xs-2 col-sm-2 col-md-2 col-lg-2 control-label no-padding-right">标题</label>
                        <div class="col-xs-10 col-sm-10 col-md-10 col-lg-10">
                            <input type="text" class="form-control" id="title" placeholder="标题" name="title" value="{$article_data.title}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="author" class="col-xs-2 col-sm-2 col-md-2 col-lg-2 control-label no-padding-right">作者</label>
                        <div class="col-xs-10 col-sm-10 col-md-10 col-lg-10">
                            <input type="text" class="form-control" id="author" placeholder="作者" name="author" value="{$article_data.author}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="keywords" class="col-xs-2 col-sm-2 col-md-2 col-lg-2 control-label no-padding-right">关键词</label>
                        <div class="col-xs-10 col-sm-10 col-md-10 col-lg-10">
                            <input type="text" class="form-control" id="keywords" placeholder="关键词" name="keywords" value="{$article_data.keywords}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="email" class="col-xs-2 col-sm-2 col-md-2 col-lg-2 control-label no-padding-right">邮箱</label>
                        <div class="col-xs-10 col-sm-10 col-md-10 col-lg-10">
                            <input type="text" class="form-control" id="email" placeholder="邮箱" name="email" value="{$article_data.email}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="link_url" class="col-xs-2 col-sm-2 col-md-2 col-lg-2 control-label no-padding-right">跳转链接</label>
                        <div class="col-xs-10 col-sm-10 col-md-10 col-lg-10">
                            <input type="text" class="form-control" id="link_url" placeholder="跳转链接" name="link_url" value="{$article_data.link_url}">
                        </div>
                    </div>

                    <div class="form-group">
                        <label  class="col-xs-2 col-sm-2 col-md-2 col-lg-2 control-label no-padding-right" style="padding-top: 0px !important;">是否显示</label>
                        <div class="col-xs-2 col-sm-2 col-md-2 col-lg-2">
                            <label>
                                <input name="show_status" type="radio" class="colored-blue" value="{$Think.config.cost.SHOWSTATUSHAVE['VAL']}" {if condition="($article_data.show_status == $Think.config.cost.SHOWSTATUSHAVE['VAL'])"} checked="checked" {/if}>
                                <span class="text">{$Think.config.cost.SHOWSTATUSHAVE['DESC']}</span>
                            </label>
                        </div>
                        <div class="col-xs-2 col-sm-2 col-md-2 col-lg-2">
                            <label>
                                <input name="show_status" type="radio" class="colored-danger" value="{$Think.config.cost.SHOWSTATUSNONE['VAL']}" {if condition="($article_data.show_status == $Think.config.cost.SHOWSTATUSNONE['VAL'])"} checked="checked" {/if}>
                                <span class="text">{$Think.config.cost.SHOWSTATUSNONE['DESC']}</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label  class="col-xs-2 col-sm-2 col-md-2 col-lg-2 control-label no-padding-right" style="padding-top: 0px !important;">是否置顶</label>
                        <div class="col-xs-2 col-sm-2 col-md-2 col-lg-2">
                            <label>
                                <input name="show_top" type="radio" class="colored-blue" value="{$Think.config.cost.SHOWTOPHAVE['VAL']}" {if condition="($article_data.show_top == $Think.config.cost.SHOWTOPHAVE['VAL'])"} checked="checked" {/if}>
                                <span class="text">{$Think.config.cost.SHOWTOPHAVE['DESC']}</span>
                            </label>
                        </div>
                        <div class="col-xs-2 col-sm-2 col-md-2 col-lg-2">
                            <label>
                                <input name="show_top" type="radio" class="colored-danger" value="{$Think.config.cost.SHOWTOPNONE['VAL']}" {if condition="($article_data.show_top == $Think.config.cost.SHOWTOPNONE['VAL'])"} checked="checked" {/if}>
                                <span class="text">{$Think.config.cost.SHOWTOPNONE['DESC']}</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label  class="col-xs-2 col-sm-2 col-md-2 col-lg-2 control-label no-padding-right">描述</label>
                        <div class="col-xs-10 col-sm-10 col-md-10 col-lg-10">
                            <textarea class="form-control" rows="3" placeholder="描述" name="description">{$article_data.description}</textarea>
                        </div>
                    </div>

                    <div class="form-group">
                        <label  class="col-xs-2 col-sm-2 col-md-2 col-lg-2 control-label no-padding-right">内容</label>
                        <div class="col-xs-10 col-sm-10 col-md-10 col-lg-10">
                            <!-- 加载编辑器的容器 -->
                            <script id="container" name="content" type="text/plain">这里写你的初始化内容</script>
                            <!-- 配置文件 -->
                            <script type="text/javascript" src="__STATIC__/ueditor/ueditor.config.js"></script>
                            <!-- 编辑器源码文件 -->
                            <script type="text/javascript" src="__STATIC__/ueditor/ueditor.all.min.js"></script>
                            <!-- 实例化编辑器 -->
                            <script type="text/javascript">
                                var ue = UE.getEditor('container',{
                                    toolbars: [[
                                        'fullscreen', 'source', '|', 'undo', 'redo', '|',
                                        'bold', 'italic', 'underline', 'fontborder', 'strikethrough', 'superscript', 'subscript', 'removeformat', 'formatmatch', 'autotypeset', 'blockquote', 'pasteplain', '|', 'forecolor', 'backcolor', 'insertorderedlist', 'insertunorderedlist', 'selectall', 'cleardoc', '|',
                                        'rowspacingtop', 'rowspacingbottom', 'lineheight', '|',
                                        'customstyle', 'paragraph', 'fontfamily', 'fontsize', '|',
                                        'directionalityltr', 'directionalityrtl', 'indent', '|',
                                        'justifyleft', 'justifycenter', 'justifyright', 'justifyjustify', '|', 'touppercase', 'tolowercase', '|',
                                        'link', 'unlink', 'anchor', '|', 'imagenone', 'imageleft', 'imageright', 'imagecenter', '|',
                                        'simpleupload', 'emotion', 'pagebreak', 'template', 'background', '|',
                                        'horizontal', 'date', 'time', 'spechars', 'snapscreen', '|',
                                        'inserttable', 'deletetable', 'insertparagraphbeforetable', 'insertrow', 'deleterow', 'insertcol', 'deletecol', 'mergecells', 'mergeright', 'mergedown', 'splittocells', 'splittorows', 'splittocols', 'charts', '|',
                                        'print', 'preview', 'searchreplace', 'drafts', 'help'
                                    ]],
                                    autoHeightEnabled: true
                                });
                                /*卑微小谭注释：上传图片时携带参数*/

                                ue.ready(function () {
                                    let content="<?php echo htmlspecialchars_decode($article_data['content']); ?>";
                                    ue.setContent(content);//设置富文本编辑器初始化数据
                                    // ue.setContent("<p>fsdgsdfgsd<img src='http://img.baidu.com/hi/jx2/j_0012.gif'/></p>");
                                    ue.execCommand('serverparam', function(editor) {
                                        return {
                                            'tableName': "tps_article",
                                            'idFieldName': "article_id",
                                            'imgFieldName': "content_img",
                                            'idFieldValue': "{$article_data.article_id}"
                                        };
                                    });
                                });
                            </script>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="col-xs-offset-2 col-sm-offset-2 col-md-offset-2 col-lg-offset-2  col-xs-10 col-sm-10 col-md-10 col-lg-10">
                            <button id="submit" class="btn btn-blue">保存</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<script src="__STATIC__/js/validation/bootstrapvalidator.js"></script>
<!--Basic Scripts-->
<script src="__STATIC__/js/jquery.serializejson.min.js" type="text/javascript" ></script>
<script src="__STATIC__/js/bootstrap.min.js"></script>
<script src="__STATIC__/js/slimscroll/jquery.slimscroll.min.js"></script>

<!--Beyond Scripts-->
<script src="__STATIC__/js/beyond.min.js"></script>
<script src="__STATIC__/js/common/cost-common.js"></script>
<script>
    $(function () {
        layui.use(['layer', 'form',"laydate"], function(){
            var layer = layui.layer;
            var form = layui.form;
            var laydate = layui.laydate;
        });
        $('#togglingForm').bootstrapValidator({
            message: 'This value is not valid',
            feedbackIcons: {
                valid: 'glyphicon glyphicon-ok',
                invalid: 'glyphicon glyphicon-remove',
                validating: 'glyphicon glyphicon-refresh'
            },
            fields: {
                title: {
                    validators: {
                        notEmpty: {
                            message: 'The title is required'
                        },
                    }
                },
                author: {
                    validators: {
                        notEmpty: {
                            message: 'The author is required'
                        },
                    }
                },
                keywords: {
                    validators: {
                        notEmpty: {
                            message: 'The keywords is required'
                        },
                    }
                },
                email: {
                    validators: {
                        notEmpty: {
                            message: 'The email is required'
                        },
                        regexp: {
                            regexp:  /^[a-zA-Z0-9_.-]+@[a-zA-Z0-9-]+(\.[a-zA-Z0-9-]+)*\.[a-zA-Z0-9]{2,6}$/,
                            message: 'The email Non conformity'
                        },
                    }
                },
                link_url: {
                    validators: {
                        notEmpty: {
                            message: 'The link_url is required'
                        },
                        regexp: {
                            regexp:  /((([A-Za-z]{3,9}:(?:\/\/)?)(?:[\-;:&=\+\$,\w]+@)?[A-Za-z0-9\.\-]+|(?:www\.|[\-;:&=\+\$,\w]+@)[A-Za-z0-9\.\-]+)((?:\/[\+~%\/\.\w\-_]*)?\??(?:[\-\+=&;%@\.\w_]*)#?(?:[\.\!\/\\\w]*))?)/,
                            message: 'The link_url Non conformity'
                        },
                    }
                },
                description: {
                    validators: {
                        notEmpty: {
                            message: 'The description is required'
                        },
                    }
                },
            }
        });

        // $("#togglingForm").submit(function(ev){ev.preventDefault();});
        $("#submit").on("click", function(){
            //对编辑器的操作最好在编辑器ready之后再做
            /*卑微小谭注释：点击事件时获取ueditor编辑内容*/
            ue.ready(function() {
                //获取html内容，返回: <p>hello</p>
                let html = ue.getContent();
                //获取纯文本内容，返回: hello
                let txt = ue.getContentTxt();
                window.ueditorHtml=html;
            });
            let bootstrapValidator = $("#togglingForm").data('bootstrapValidator');
            bootstrapValidator.validate();
            if(bootstrapValidator.isValid()){
                let thisData= $("#togglingForm").serializeJSON();
                thisData.content=window.ueditorHtml;
                let id = "{$article_data.article_id}";
                $.post("{:url('article/save_article_edit')}", {"data":thisData,"id":id}, function (callback) {
                    if (callback.status == 1) {
                        layer.msg(callback.msg, {
                            icon: 1,
                            time: 1000
                        }, function(){
                            var indexs = parent.layer.getFrameIndex(window.name);//关闭当前iframe
                            parent.layer.close(indexs);
                            var obj={
                                "offset" : 0,
                                "num" : 10,
                                "pagetouse" : true,
                                "url" : "{:url('article/content')}",
                                "targetElem" : "#content",
                                "formElem" : "#article_form",
                                "pageCountElem" : "#page-count"
                            };
                            parent.list(obj);
                        });
                    }else{
                        layer.msg(callback.msg, {time: 1000,icon: 2});
                    }
                }, "json");
            }
        });

    });
</script>